name: Build, Release and Update feed

on:
 push:
 tags:
 - 'v*.*.*'

permissions:
 contents: write

jobs:
 release:
 runs-on: windows-latest

 steps:
 - name: Checkout repo
 uses: actions/checkout@v4
 with:
 fetch-depth: 0
 persist-credentials: true

 - name: Setup .NET
 uses: actions/setup-dotnet@v3
 with:
 dotnet-version: '9.0.x'

 - name: Build publish
 run: dotnet publish iFredApps.TimeTracker.UI/iFredApps.TimeTracker.UI.csproj -c Release -r win-x64 --self-contained false -o publish

 - name: Zip artifacts
 run: powershell -Command "Compress-Archive -Path publish\* -DestinationPath TimeTracker-Setup.zip"

 - name: Create Release
 id: create_release
 uses: actions/create-release@v1
 env:
 GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
 with:
 tag_name: ${{ github.ref_name }}
 release_name: Release ${{ github.ref_name }}
 body: "Automated release for ${{ github.ref_name }}"

 - name: Upload asset
 uses: actions/upload-release-asset@v1
 with:
 upload_url: ${{ steps.create_release.outputs.upload_url }}
 asset_path: ./TimeTracker-Setup.zip
 asset_name: TimeTracker-Setup.zip
 asset_content_type: application/zip

 - name: Update docs/updates.xml in main
 shell: pwsh
 env:
 RELEASE_TAG: ${{ github.ref_name }}
 REPO: ${{ github.repository }}
 GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
 run: |
 git config user.name "github-actions[bot]"
 git config user.email "github-actions[bot]@users.noreply.github.com"
 git fetch origin main:refs/remotes/origin/main
 git checkout -B main origin/main
 $version = $env:RELEASE_TAG -replace '^v',''
 $xml = @"
<?xml version="1.0" encoding="utf-8"?>
<item>
 <version>$version</version>
 <url>https://github.com/$env:REPO/releases/download/$env:RELEASE_TAG/TimeTracker-Setup.zip</url>
 <mandatory>false</mandatory>
 <changelog>Automated release $env:RELEASE_TAG</changelog>
</item>
"@
 Set-Content -Path docs/updates.xml -Value $xml -Encoding UTF8
 git add docs/updates.xml
 git commit -m "Update updates.xml for $env:RELEASE_TAG" || Write-Host "No changes to commit"
 git push origin main
